<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WorkOrder Request</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --gap:10px; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; padding:12px; }
    h2 { margin:0 0 10px; }
    .row { display:grid; grid-template-columns: 160px 1fr; gap:var(--gap); align-items:center; margin-bottom:10px; }
    .row-full { display:block; margin-bottom:10px; }
    label { font-weight:600; }
    input, select, textarea, button { width:100%; padding:8px; box-sizing:border-box; }
    input[readonly] { background:#f3f4f6; }
    textarea { min-height:120px; }
    small { color:#6b7280; display:block; margin-top:4px; }
    .btns { display:flex; gap:8px; margin-top:8px; }
    button { border:0; border-radius:8px; cursor:pointer; }
    .primary { background:#2563eb; color:white; }
    #status { font-size:12px; color:#6b7280; margin-top:8px; }
    .ok { color:#065f46 !important; }
    .err { color:#7f1d1d !important; }
  </style>
</head>
<body>
  <h2>Create WorkOrder</h2>

  <!-- Wrap everything in a form so all fields are sent -->
  <form id="woForm">
    <div class="row">
      <label for="subject">Subject</label>
      <div>
        <input id="subject" name="subject" type="text" placeholder='e.g., "Medical devices in China", "Breweries in Colombia"' required />
        <small>Topic of the call. Examples: “Medical devices in China”, “Breweries in Colombia”.</small>
      </div>
    </div>

    <div class="row">
      <label for="frontId">FrontID</label>
      <input id="frontId" name="front_id" type="text" readonly />
    </div>

    <div class="row">
      <label for="clientEmail">Client’s email</label>
      <input id="clientEmail" name="client_email" type="email" placeholder="name@company.com" required />
    </div>

    <div class="row">
      <label for="datetime">Date & Time booking</label>
      <input id="datetime" name="datetime_local" type="datetime-local" required />
    </div>

    <div class="row">
      <label for="serviceType">Service Type</label>
      <select id="serviceType" name="service_type" required></select>
    </div>

    <div class="row">
      <label for="srcLang">Source Language</label>
      <select id="srcLang" name="source_language" required></select>
    </div>

    <div class="row">
      <label for="tgtLang">Target Language</label>
      <select id="tgtLang" name="target_language" required></select>
    </div>

    <div class="row-full">
      <label for="description">Description</label>
      <textarea id="description" name="description" placeholder="Add job context, materials, and any special instructions…"></textarea>
      <small>Use this area to provide details the linguist needs: context, objectives, participants, materials/links, and any non-obvious requirements.</small>
    </div>

    <!-- Hidden: conversation deep link, auto-filled -->
    <input type="hidden" id="conversationUrl" name="conversation_url" />

    <div class="btns">
      <button id="send" class="primary" type="submit">Submit</button>
    </div>
  </form>

  <div id="status">Waiting for conversation…</div>

  <!-- Front Plugin SDK -->
  <script src="https://dl.frontapp.com/libs/plugin-sdk-1.8.1.min.js"></script>
  <script>
    // ======= CONFIG =======
    const ZAP_URL = "https://hooks.zapier.com/hooks/catch/9441479/u6lrbqp/"; // <-- replace

    // ======= Options =======
    const LANGUAGES = [
      "Mandarin","Japanese","Korean","French","Spanish","Portuguese","German","EU Portuguese","EU French","EU Spanish",
      "Afrikaans","Amazigh","Amharic","Arabic","Asturian","Azerbaijani","Bahasa Indonesia","Balinese","Basque","Brazilian Portuguese",
      "Bengali","Bosnian","Bulgarian","Burmese","Canadian French","Cantonese","Catalan","Creole","Croatian","Czech",
      "Danish","Dari","Dutch","Esperanto","Estonian","Farsi","Finnish","Flemish","Georgian","Greek",
      "Gujarati","Hakka","Hebrew","Hindi","Hmong","Hokkien","Hungarian","Italian","Javanese","Kannada",
      "Khmer","Kurdish","Latin American Spanish","Lao","Lithuanian","Macedonian","Malay","Chinese (Hongkong)","Marathi","Marshallese",
      "Mongolian","Nepalese","Norwegian","Pashto","Persian","Polish","Punjabi","Romanian","Russian","Scots",
      "Serbian","Sinhalese","Slavic","Slovak","Somali","Sundanese","Swahili","Swedish","Tagalog","Taiwanese",
      "Tamil","Telugu","Teochew","Thai","Turkish","Ukrainian","Urdu","Uyghur","Vietnamese","Other"
    ];

    const SERVICE_TYPES = [
      "[CI] Interpret a call (industry discussion)",
      "[CI] Interpret a call (IR / management team)",
      "[CI] Interpret an on-site meeting",
      "[SI] Interpret a call (industry discussion)",
      "[SI] Interpret a call (IR / management team)",
      "[SI] Interpret an on-site meeting",
      "[SI] Interpret a call solo (industry discussion)",
      "[SI] Interpret a call solo (IR / management team)",
      "[SI] Interpret an on-site meeting solo",
      "Translate a document",
      "Translate a survey",
      "HITL",
      "HITL Lite",
      "Machine",
      "HITL Verbatim",
      "[IDI] Moderate a call",
      "[FGD] Moderate a call",
      "Briefing - Moderation",
      "Briefing - Interpretation",
      "[Other] Bespoke services"
    ];

    // ======= DOM =======
    const $ = id => document.getElementById(id);
    const el = {
      form: $("woForm"),
      subject: $("subject"),
      frontId: $("frontId"),
      clientEmail: $("clientEmail"),
      datetime: $("datetime"),
      serviceType: $("serviceType"),
      srcLang: $("srcLang"),
      tgtLang: $("tgtLang"),
      description: $("description"),
      conversationUrl: $("conversationUrl"),
      status: $("status"),
    };

    function buildSelectOptions(list) {
      return '<option value="" disabled selected>Select…</option>' +
        list.map(v => `<option value="${v}">${v}</option>`).join("");
    }
    function fillSelects() {
      el.srcLang.innerHTML = buildSelectOptions(LANGUAGES);
      el.tgtLang.innerHTML = buildSelectOptions(LANGUAGES);
      el.serviceType.innerHTML = buildSelectOptions(SERVICE_TYPES);
    }
    fillSelects();

    let ctxCache = null;

    // ======= Front Context =======
    Front.contextUpdates.subscribe(async (ctx) => {
      ctxCache = ctx;

      if (ctx?.type !== "singleConversation" || !ctx.conversation) {
        el.status.textContent = "Open a conversation to use the form.";
        return;
      }

      // Front conversation id + deep link
      el.frontId.value = ctx.conversation.id;
      el.conversationUrl.value = `https://app.frontapp.com/open/c/${ctx.conversation.id}`;

      // Prefill Subject if empty
      if (!el.subject.value && ctx.conversation.subject) {
        el.subject.value = ctx.conversation.subject;
      }

      // Prefill Client email from very first sender in the thread (oldest inbound)
      try {
        const page = await ctx.listMessages();
        const msgs = page?.results || [];
        const firstInbound = msgs.find(m => m.direction === "inbound" && m.author?.handle);
        if (firstInbound?.author?.handle && firstInbound.author.handle.includes("@")) {
          if (!el.clientEmail.value) {
            el.clientEmail.value = firstInbound.author.handle;
          }
        }
      } catch (e) { /* ignore */ }

      el.status.textContent = "Context loaded.";
    });

    // ======= Validation =======
    function validate() {
      if (!ZAP_URL.startsWith("https://hooks.zapier.com/")) return "Set your Zapier URL in the code.";
      if (!el.subject.value.trim()) return "Subject is required.";
      if (!el.clientEmail.value.trim()) return "Client’s email is required.";
      if (!el.datetime.value.trim()) return "Date & time is required.";
      if (!el.serviceType.value) return "Service Type is required.";
      if (!el.srcLang.value) return "Source Language is required.";
      if (!el.tgtLang.value) return "Target Language is required.";
      return null;
    }

    // ======= Submit: POST all fields as body (x-www-form-urlencoded) =======
    el.form.addEventListener("submit", async (evt) => {
      evt.preventDefault();

      const err = validate();
      if (err) { el.status.textContent = err; el.status.className = "err"; return; }

      // Collect ALL form fields automatically
      const formData = new FormData(el.form);

      // Optional: trim common fields before sending
      formData.set("subject", (formData.get("subject") || "").toString().trim());
      formData.set("client_email", (formData.get("client_email") || "").toString().trim());
      formData.set("description", (formData.get("description") || "").toString().trim());

      // Convert to URL-encoded body so Zapier sees keys in request.data
      const body = new URLSearchParams(formData);

      el.status.textContent = "Sending…";
      el.status.className = "";

      try {
        const res = await fetch(ZAP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body
        });

        const text = await res.text().catch(() => "");
        if (!res.ok) {
          el.status.textContent = `Submit failed: HTTP ${res.status} ${res.statusText}${text ? " — " + text : ""}`;
          el.status.className = "err";
          return;
        }

        el.status.textContent = "Submitted successfully. Your WorkOrder flow should continue.";
        el.status.className = "ok";
        // Optional: el.form.reset();
      } catch (e) {
        el.status.textContent = `Network/CORS error: ${e?.message || e}`;
        el.status.className = "err";
      }
    });
  </script>
</body>
</html>
