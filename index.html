<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WorkOrder Request</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --gap:10px; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; padding:12px; }
    h2 { margin:0 0 10px; }
    .row { display:grid; grid-template-columns: 160px 1fr; gap:var(--gap); align-items:center; margin-bottom:10px; }
    .row-full { display:block; margin-bottom:10px; }
    label { font-weight:600; }
    input, select, textarea, button { width:100%; padding:8px; box-sizing:border-box; }
    input[readonly] { background:#f3f4f6; }
    textarea { min-height:120px; }
    small { color:#6b7280; display:block; margin-top:4px; }
    .btns { display:flex; gap:8px; margin-top:8px; }
    button { border:0; border-radius:8px; cursor:pointer; }
    .primary { background:#2563eb; color:white; }
    #status { font-size:12px; color:#6b7280; margin-top:8px; }
    .ok { color:#065f46 !important; }
    .err { color:#7f1d1d !important; }
  </style>
</head>
<body>
  <h2>Create Request in Salesforce</h2>

  <div class="row">
    <label for="subject">Subject</label>
    <div>
      <input id="subject" type="text" placeholder='e.g., "Medical devices in China", "Breweries in Colombia"' required />
      <small>Topic of the call. Examples: “Medical devices in China”, “Breweries in Colombia”.</small>
    </div>
  </div>

  <div class="row">
    <label for="frontId">FrontID</label>
    <input id="frontId" type="text" readonly />
  </div>

  <div class="row">
    <label for="clientEmail">Client’s email</label>
    <div>
      <input id="clientEmail" type="email" placeholder="please make sure the contact is available in Salesforce" required />
      <!-- NEW: hint showing detected first sender -->
      <small id="clientEmailHint" style="display:none;"></small>
    </div>
  </div>

  <div class="row">
    <label for="datetime">Date & Time booking</label>
    <input id="datetime" type="datetime-local" required />
  </div>

  <!-- NEW: Service Type -->
  <div class="row">
    <label for="serviceType">Service Type</label>
    <select id="serviceType" required></select>
  </div>

  <div class="row">
    <label for="srcLang">Source Language</label>
    <select id="srcLang" required></select>
  </div>

  <div class="row">
    <label for="tgtLang">Target Language</label>
    <select id="tgtLang" required></select>
  </div>

  <div class="row-full">
    <label for="description">Description</label>
    <textarea id="description" placeholder="Add job context, materials, and any special instructions…"></textarea>
    <small>Use this area to provide details the linguist needs: context, objectives, participants, materials/links, and any non-obvious requirements.</small>
  </div>

  <div class="btns">
    <button id="send" class="primary" type="button">Submit</button>
  </div>

  <div id="status">Waiting for conversation…</div>

  <!-- Front Plugin SDK -->
  <script src="https://dl.frontapp.com/libs/plugin-sdk-1.8.1.min.js"></script>
  <script>
    const ZAP_URL = "https://hooks.zapier.com/hooks/catch/9441479/uthb9na/";

    // Fixed quotes on "English"
    const LANGUAGES = ["English","Mandarin","Japanese","Korean","French","Spanish","Portuguese","German","EU Portuguese","EU French","EU Spanish",
      "Afrikaans","Amazigh","Amharic","Arabic","Asturian","Azerbaijani","Bahasa Indonesia","Balinese","Basque","Brazilian Portuguese",
      "Bengali","Bosnian","Bulgarian","Burmese","Canadian French","Cantonese","Catalan","Creole","Croatian","Czech",
      "Danish","Dari","Dutch","Esperanto","Estonian","Farsi","Finnish","Flemish","Georgian","Greek",
      "Gujarati","Hakka","Hebrew","Hindi","Hmong","Hokkien","Hungarian","Italian","Javanese","Kannada",
      "Khmer","Kurdish","Latin American Spanish","Lao","Lithuanian","Macedonian","Malay","Chinese (Hongkong)","Marathi","Marshallese",
      "Mongolian","Nepalese","Norwegian","Pashto","Persian","Polish","Punjabi","Romanian","Russian","Scots",
      "Serbian","Sinhalese","Slavic","Slovak","Somali","Sundanese","Swahili","Swedish","Tagalog","Taiwanese",
      "Tamil","Telugu","Teochew","Thai","Turkish","Ukrainian","Urdu","Uyghur","Vietnamese","Other"];

    const SERVICE_TYPES = ["[CI] Interpret a call (industry discussion)",
      "[CI] Interpret a call (IR / management team)",
      "[CI] Interpret an on-site meeting",
      "[SI] Interpret a call (industry discussion)",
      "[SI] Interpret a call (IR / management team)",
      "[SI] Interpret an on-site meeting",
      "[SI] Interpret a call solo (industry discussion)",
      "[SI] Interpret a call solo (IR / management team)",
      "[SI] Interpret an on-site meeting solo",
      "Translate a document",
      "Translate a survey",
      "HITL",
      "HITL Lite",
      "Machine",
      "HITL Verbatim",
      "[IDI] Moderate a call",
      "[FGD] Moderate a call",
      "Briefing - Moderation",
      "Briefing - Interpretation",
      "[Other] Bespoke services"];

    const $ = id => document.getElementById(id);
    const el = {
      subject: $("subject"),
      frontId: $("frontId"),
      clientEmail: $("clientEmail"),
      clientEmailHint: $("clientEmailHint"),
      datetime: $("datetime"),
      serviceType: $("serviceType"),
      srcLang: $("srcLang"),
      tgtLang: $("tgtLang"),
      description: $("description"),
      send: $("send"),
      status: $("status"),
    };

    function buildSelectOptions(list) {
      return '<option value="" disabled selected>Select…</option>' +
        list.map(v => `<option value="${v}">${v}</option>`).join("");
    }
    function fillSelects() {
      el.srcLang.innerHTML = buildSelectOptions(LANGUAGES);
      el.tgtLang.innerHTML = buildSelectOptions(LANGUAGES);
      el.serviceType.innerHTML = buildSelectOptions(SERVICE_TYPES);
    }
    fillSelects();
    let submitter = { name: "", email: "" };

    // Helper to extract the earliest inbound sender email robustly
    async function detectFirstSenderEmail(ctx) {
      try {
        const page = await ctx.listMessages?.();
        const msgs = page?.results || [];

        // Find earliest inbound by timestamp if available
        const ts = m => m.created_at ?? m.received_at ?? m.date ?? 0;
        const inbound = msgs.filter(m =>
          (m.direction === "inbound" || m.status === "inbound") &&
          (m.author?.handle || m.recipient?.handle)
        ).sort((a,b) => ts(a) - ts(b));

        const emailFromMsgs = inbound[0]?.author?.handle || inbound[0]?.recipient?.handle;

        if (emailFromMsgs && emailFromMsgs.includes("@")) return emailFromMsgs;

        // Fallback: recipients list (pick first sender role or first entry)
        const recips = await ctx.listRecipients?.();
        const firstSender = recips?.results?.find(r => r.role === "sender") || recips?.results?.[0];
        const emailFromRecips = firstSender?.handle;
        if (emailFromRecips && emailFromRecips.includes("@")) return emailFromRecips;

        return null;
      } catch (e) {
        return null;
      }
    }

    let ctxCache = null;
    Front.contextUpdates.subscribe(async (ctx) => {
      ctxCache = ctx;
      submitter.name = ctx?.teammate?.name || "";
submitter.email = ctx?.teammate?.email || "";

      if (ctx?.type !== "singleConversation" || !ctx.conversation) {
        el.status.textContent = "Open a conversation to use the form.";
        return;
      }

      // Set FrontID (read-only)
      el.frontId.value = ctx.conversation.id;

      // Prefill Subject if empty
      if (!el.subject.value && ctx.conversation.subject) {
        el.subject.value = ctx.conversation.subject;
      }

      // NEW: Auto-detect first sender email, fill field if empty, and show hint
      const detected = await detectFirstSenderEmail(ctx);
      if (detected && !el.clientEmail.value) {
        el.clientEmail.value = detected;
      }
      if (detected) {
        el.clientEmailHint.textContent = `Auto-detected first sender: ${detected}`;
        el.clientEmailHint.style.display = "block";
      } else {
        el.clientEmailHint.textContent = "";
        el.clientEmailHint.style.display = "none";
      }

      el.status.textContent = "Context loaded.";
    });

    function validate() {
      if (!ZAP_URL.startsWith("https://hooks.zapier.com/")) return "Set your Zapier URL in the code.";
      if (!el.subject.value.trim()) return "Subject is required.";
      if (!el.clientEmail.value.trim()) return "Client’s email is required.";
      if (!el.datetime.value.trim()) return "Date & time is required.";
      if (!el.serviceType.value) return "Service Type is required.";
      if (!el.srcLang.value) return "Source Language is required.";
      if (!el.tgtLang.value) return "Target Language is required.";
      return null;
    }

    // Submit handler (posts all fields as x-www-form-urlencoded)
    el.send.addEventListener("click", async () => {
      const err = validate();
      if (err) { el.status.textContent = err; el.status.className = "err"; return; }

      const body = new URLSearchParams();
      body.set("subject", el.subject.value.trim());
      body.set("front_id", el.frontId.value || "");
      if (el.frontId.value) body.set("conversation_url", `https://app.frontapp.com/open/c/${el.frontId.value}`);
      body.set("client_email", el.clientEmail.value.trim());
      body.set("datetime_local", el.datetime.value);
      body.set("service_type", el.serviceType.value);
      body.set("source_language", el.srcLang.value);
      body.set("target_language", el.tgtLang.value);
      body.set("submitter_name", submitter.name);
body.set("submitter_email", submitter.email);
      body.set("description", el.description.value.trim());

      el.status.textContent = "Sending…";
      el.status.className = "";

      try {
        const res = await fetch(ZAP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body
        });
        const text = await res.text().catch(() => "");
        if (!res.ok) {
          el.status.textContent = `Submit failed: HTTP ${res.status} ${res.statusText}${text ? " — " + text : ""}`;
          el.status.className = "err";
          return;
        }
        el.status.textContent = "Submitted successfully. Your WorkOrder flow should continue.";
        el.status.className = "ok";
      } catch (e) {
        el.status.textContent = `Network/CORS error: ${e?.message || e}`;
        el.status.className = "err";
      }
    });
  </script>
</body>
</html>
